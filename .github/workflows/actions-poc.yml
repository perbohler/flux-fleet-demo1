name: GitHub Actions Demo
on: 
  push:
    branches:
      - first-actions-pipeline
jobs:
  Explore-GitHub-Actions:
    name: this is the job to demo
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: echo "ğŸ This job's status is ${{ job.status }}."
  build-mock-job:
    name: this job pretends to build an image
    runs-on: ubuntu-latest
    outputs:
      imagename: ${{ steps.imagebuildstep.name }}
      imagerepo: ${{ steps.imagebuildstep.repo }}
      imagetag: ${{ steps.imagebuildstep.tag }}
    steps:
      - name: mock image builder
        id: imagebuildstep
        run: |
        myimagename="http-echo"
        echo "::set-output name=name::$myimagename"
        myimagerepo="hashicorp/http-echo"
        echo "::set-output name=repo::$myimagerepo"
        myimagetag="alpine"
        echo "::set-output name=tag::$myimagetag"

  My-kustomize-job:
    name: this is my update image jobÃŸ
    runs-on: ubuntu-latest
    needs: build-mock-job
    steps:
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1
        with:
          kustomize-version: "4.4.1"
      
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Switch out image tag
        run: |
          cd ${{ github.workspace }}/poc-git-tag/tags
          kustomize edit set image http-echo:hashicorp/http-echo:latest
#          kustomize edit set image ${{needs.build-mock-job.outputs.imagename}}/${{needs.build-mock-job.outputs.imagerepo}}/${{needs.build-mock-job.outputs.imagetag}}


      - name: Commit and push
        run: |
          git config user.name "GitHub Actions pipeline "
          git config user.email "<per@vipps.no>"
          cd ${{ github.workspace }}
          git commit -am "updates image tag"
          git tag -d six
          git push origin :refs/tags/six
          git tag six
          git push --tags origin ${{ github.ref }}
